---
layout:     post
title:      Laravel 5.5 ä½¿ç”¨ JWT
subtitle:   å¿«é€Ÿå®ç°å¤šè¡¨è®¤è¯
date:       2018-10-20
author:     Qyh
header-img: img/post-bg-2015.jpg
catalog: true
tags:
    - php
    - laravel
    - jwt
---

> laravelå­¦é™¢è¯´ï¼šç”¨æˆ·è®¤è¯æ˜¯Webåº”ç”¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼ŒåŸºäºAPIçš„ç”¨æˆ·è®¤è¯æœ‰ä¸¤ä¸ªæœ€ä½³è§£å†³æ–¹æ¡ˆ â€”â€” OAuth 2.0 å’Œ JWTï¼ˆJSON Web Tokenï¼‰ã€‚

# ä¸€ã€JWTå®šä¹‰

## åˆ’é‡ç‚¹å•¦ï¼Œä¸‹é¢è¿˜æ˜¯laravelå­¦é™¢è¯´çš„ï¼š

- JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ä¸ªéå¸¸è½»å·§çš„è§„èŒƒã€‚è¿™ä¸ªè§„èŒƒå…è®¸æˆ‘ä»¬ä½¿ç”¨JWTåœ¨ç”¨æˆ·å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ é€’å®‰å…¨å¯é çš„ä¿¡æ¯ã€‚
- ä¸€ä¸ªJWTå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå¤´éƒ¨ã€è½½è·ä¸ç­¾åã€‚

# äºŒã€Laravel 5 çš„é¡¹ç›®ä¸­é›†æˆ JWT

## 1.å®‰è£…jwt

### 1ï¼‰åˆ›å»ºlaravel 5çš„é¡¹ç›®

è¿™é‡Œæˆ‘æ¨èä½¿ç”¨5.4+çš„ç‰ˆæœ¬ï¼Œæˆ‘ç”¨çš„æ˜¯5.5çš„ç‰ˆæœ¬ã€‚åæ­£ç°åœ¨éƒ½æ›´æ–°åˆ°5.7äº†å¯¹å§ï¼Œä½•è‹¦ç”¨5.2ã€5.3å‘¢ï¼Ÿå®ƒä»¬æ˜¯è¿Ÿæ—©è¦è¢«æ‹æ­»åœ¨æ²™æ»©ä¸Šçš„!
```
$ laravel new laravel-jwt
```
ä¹Ÿå¯ä»¥ä½¿ç”¨composeråˆ›å»ºæŒ‡å®šç‰ˆæœ¬çš„é¡¹ç›®ï¼š
```
$ composer create-project --prefer-dist laravel/laravel laravel-jwt 5.5
```
è¿™ä¸€æ­¥éƒ½ä¸ä¼šçš„è¯·ç§»æ­¥ [laravelå­¦é™¢](https://laravelacademy.org/)ï¼Œç„¶åé¢å£æ€è¿‡+åšä¿¯å§æ’‘+è¯·åƒè¾£æ¡å§ã€‚

### 2ï¼‰åœ¨é¡¹ç›®é‡Œé›†å®‰è£…jwt 1.0ä¾èµ–

ä¸ºä¸ºä¸ºä¸ºä¸ºä»€ä¹ˆè¦ç”¨1.0å‘¢ï¼Œå› ä¸ºæœ¬æ–‡æ•™æˆçš„æ˜¯å®ç°å¤šè¡¨è®¤è¯ï¼Œè¸©è¿‡æ— æ•°ä¸ªå‘çš„æˆ‘è¡¨ç¤ºï¼Œ1.0ä»¥ä¸‹çš„ç‰ˆæœ¬å¯¹å¤šè¡¨è®¤è¯æ˜¯å¾ˆä¸å‹å¥½çš„ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æ¯ä¸ªæ§åˆ¶å™¨ä¸­å£°æ˜ç”¨æˆ·è¡¨å’Œæ¨¡å‹æ‰èƒ½ä½¿å¤šè¡¨è®¤è¯ç”Ÿæ•ˆï¼Œéº»çƒ¦å¾—ä¸€åŒ¹ï¼æ‰€ä»¥ï¼Œå…„deiï¼Œç”¨1.0å§ã€‚åªè¦æ˜¯1.0+çš„ç‰ˆæœ¬å°±å¯ä»¥å“ˆï¼Œå…·ä½“ä»€ä¹ˆç‰ˆæœ¬ä¸åšé™åˆ¶ï¼Œä½ å¼€å¿ƒå°±å¥½ï¼Œæ‰€æœ‰ç‰ˆæœ¬éƒ½å¯ä»¥åœ¨laravel jwtçš„gitä»“åº“  [tymondesigns/jwt-auth](https://github.com/tymondesigns/jwt-auth) é‡Œæ‰¾åˆ°ï¼Œè²Œä¼¼ç°åœ¨1.0çš„æœ€æ–°ç‰ˆæ˜¯1.0.0-rc.3ï¼Œ2.0çš„ç‰ˆæœ¬ä¹Ÿå‡ºäº†ï¼ˆä¸è¿‡æˆ‘æ²¡è¯•ï¼Œå®˜æ–¹çš„wikiä¹Ÿå¾ˆè€æ—§ï¼Œè¿˜åœç•™åœ¨0.5çš„ç‰ˆæœ¬ï¼‰ã€‚

è·‘åäº†ï¼Œé¦–å…ˆåœ¨composer.jsonçš„requireé‡Œæ·»åŠ è¿™ä¹ˆä¸€è¡Œï¼š
```json
"tymon/jwt-auth": "1.0.0-rc.2"
```
æ¥ç€æˆ‘ä»¬æ›´æ–°ä¸€ä¸‹ä¾èµ–ï¼š
```
$ composer update
```
è£…å¥½ä¹‹åä¼šå‘ç°ï¼Œvendoré‡Œä¼šå¤šå‡ºä¸€ä¸ªtymonæ–‡ä»¶å¤¹ï¼Œè¯´æ˜ä¾èµ–å°±è£…å¥½å•¦ï¼

## 2.é…ç½®jwt

### 1ï¼‰å‘å¸ƒé…ç½®æ–‡ä»¶

æˆ‘ä¿è¯æˆ‘è¿™ç¯‡åšå®¢å·²ç»å†™é½äº†æ‰€æœ‰æ­¥éª¤ï¼Œæ¯•ç«Ÿæ˜¯å…¨ç½‘æ‹¼å‡‘å˜›ï¼Œå•Šå‘¸åŸåˆ›ï¼Œæ‰€ä»¥è¯·å¿½ç•¥å…¶ä»–åšå®¢ï¼ˆåŒ…æ‹¬laravelå­¦é™¢çš„æ•™ç¨‹ï¼‰æåˆ°çš„ä¸¤ä¸ªæ­¥éª¤ï¼šåˆ†åˆ«æ˜¯æ³¨å†Œ```Tymon\JWTAuth\Providers\LaravelServiceProvider::class```æˆ–```Tymon\JWTAuth\Providers\JWTAuthServiceProvider::class```æœåŠ¡ï¼Œä»¥åŠæ³¨å†ŒJWTAuthå’ŒJWTFactoryé—¨é¢ï¼Œå®Œå…¨ä¸ç”¨ç†å®ƒä»¬çš„ï¼Œå®ƒä»¬å·²ç»è¿‡æ—¶äº†ã€‚

æˆ‘ä»¬åªè¦ï¼š
```
php artisan vendor:publish --provider="Tymon\JWTAuth\Providers\LaravelServiceProvider"
```
è¿™æ¡å‘½ä»¤ä¼šåœ¨ä½ çš„**config**æ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆ**jwt.php**ï¼Œè¿™æ˜¯jwtçš„é…ç½®æ–‡ä»¶ï¼Œåˆ«ä¹±æ”¹ï¼ˆæˆ‘ä»¬å¾…ä¼šå†æ”¹å˜»å˜»ï¼‰ã€‚

### 2ï¼‰ç”Ÿæˆå¯†é’¥

ä¸€å¥è¯çš„äº‹å„¿ï¼ˆå¿«å¤¸æˆ‘å„¿åŒ–éŸ³å¥½å¬ï¼‰ï¼š
```
php artisan jwt:secret
```
æ³¨æ„å•Šæ˜¯secretï¼Œè€ç‰ˆæœ¬æ‰æ˜¯generateï¼Œè¿™æ¡å‘½ä»¤ä¼šåœ¨ .env æ–‡ä»¶ä¸‹ç”Ÿæˆä¸€ä¸ªåŠ å¯†å¯†é’¥ï¼Œå¦‚ï¼šJWT_SECRET=lizhijieisfoolish

# ä¸‰ã€å»ºç«‹æ•°æ®åº“

å“¼å“¼æˆ‘è·Ÿä½ è®²åˆ«çš„åšå®¢æ˜¯ä¸ä¼šæ•™ä½ æ€ä¹ˆåˆ›å»ºè¿ç§»ç”Ÿæˆæ•°æ®åº“çš„ï¼Œæ‰€ä»¥æ¬¢è¿å¤§å®¶å…³æ³¨ [æˆ‘çš„github](https://github.com/qyhxxx) å˜»å˜»å˜»(å¼ºè¡Œç¡¬å¹¿)ã€‚

## 1.ç”Ÿæˆè¿ç§»

### 1ï¼‰ç”Ÿæˆå‰å°ç”¨æˆ·è¡¨è¿ç§»ï¼š

```
php artisan make:migration create_users_table
```

### 2ï¼‰ç”Ÿæˆåå°ç”¨æˆ·è¡¨è¿ç§»ï¼š

```
php artisan make:migration create_admins_table
```

## 2.ç¼–å†™è¿ç§»ç»“æ„

### 1ï¼‰å‰å°ç”¨æˆ·è¡¨çš„è¿ç§»ä»£ç å¦‚ä¸‹ï¼š

```php
Schema::create('users', function (Blueprint $table) {
    $table->increments('id');
    $table->string('name');
    $table->string('phone')->unique();
    $table->string('password');
    $table->rememberToken();
    $table->timestamps();
});
```

### 2ï¼‰åå°ç”¨æˆ·è¡¨çš„è¿ç§»ä»£ç å¦‚ä¸‹ï¼š

```php
Schema::create('admins', function (Blueprint $table) {
    $table->incremewnts('id');
    $table->string('name');
    $table->string('password');
    $table->timestamps();
});
```

æˆ‘ç”¨æ‰‹æœºå·ä»£æ›¿é‚®ç®±äº†ï¼Œä½ æ ¹æ®ä½ çš„éœ€æ±‚è‡ªå·±çœ‹ç€åŠ~

## 3.æ‰§è¡Œè¿ç§»

è¿˜æ˜¯ä¸€å¥è¯å„¿çš„äº‹å„¿ï¼ˆå„¿åŒ–éŸ³nbï¼‰
```
php artisan migrate
```
ä¸ä¼šè¿ç§»çš„è¯·å†æ¬¡ç§»æ­¥laravelå­¦é™¢çš„æ•™ç¨‹ [æ•°æ®åº“è¿ç§» â€”â€” ä»¥ç‰ˆæœ¬æ§åˆ¶çš„æ–¹å¼ç»´æŠ¤æ•°æ®è¡¨](https://laravelacademy.org/post/8179.html)ï¼Œç„¶åæ”¾å¼ƒæ²»ç–—å§ã€‚

# å››ã€ç¼–å†™ä»£ç 

## 1.æ›´æ–°æ¨¡å‹

æˆ‘æŠŠæ¨¡å‹éƒ½æè‡ªå·±åˆ›çš„Modelsç›®å½•ä¸‹äº†ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚

### 1ï¼‰Useræ¨¡å‹ï¼š

```php
<?php

namespace App\Models;

use Illuminate\Notifications\Notifiable;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Tymon\JWTAuth\Contracts\JWTSubject;

class User extends Authenticatable implements JWTSubject
{
    use Notifiable;

    // Rest omitted for brevity

    /**
     * Get the identifier that will be stored in the subject claim of the JWT.
     *
     * @return mixed
     */
    public function getJWTIdentifier()
    {
        return $this->getKey();
    }

    /**
     * Return a key value array, containing any custom claims to be added to the JWT.
     *
     * @return array
     */
    public function getJWTCustomClaims()
    {
        return [];
    }

    /**
     * The attributes that are mass assignable.
     *
     * @var array
     */
    protected $fillable = [
        'name', 'phone', 'password',
    ];

    /**
     * The attributes that should be hidden for arrays.
     *
     * @var array
     */
    protected $hidden = [
        'password', 'remember_token',
    ];

    public static function add($data) {
        $user = self::create($data);
        return $user;
    }
}
```

### 2ï¼‰Adminæ¨¡å‹ï¼š

```php
<?php

namespace App\Models;

use Illuminate\Notifications\Notifiable;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Tymon\JWTAuth\Contracts\JWTSubject;

class Admin extends Authenticatable implements JWTSubject
{
    use Notifiable;

    // Rest omitted for brevity

    /**
     * Get the identifier that will be stored in the subject claim of the JWT.
     *
     * @return mixed
     */
    public function getJWTIdentifier()
    {
        return $this->getKey();
    }

    /**
     * Return a key value array, containing any custom claims to be added to the JWT.
     *
     * @return array
     */
    public function getJWTCustomClaims()
    {
        return [];
    }

    /**
     * The attributes that are mass assignable.
     *
     * @var array
     */
    protected $fillable = [
        'name', 'password',
    ];

    /**
     * The attributes that should be hidden for arrays.
     *
     * @var array
     */
    protected $hidden = [
        'password',
    ];

    public static function add($data) {
        $admin = self::create($data);
        return $admin;
    }
}
```
ä¸»è¦æ˜¯è¦ç»§æ‰¿JWTSubjectæ¥å£ï¼Œå¹¶å®ç°æ¥å£çš„ä¸¤ä¸ªæ–¹æ³•ï¼šgetJWTIdentifier()å’ŒgetJWTCustomClaims()ï¼ŒåŸç†æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œå¸Œæœ›ä½ ä»¬ä¸­èƒ½è¯ç”Ÿå¤§ä½¬å»æŒ–æ˜å®ƒèƒŒåçš„å¥¥å¦™ï¼Œæˆ‘é€‰æ‹©ç‹—å¸¦ã€‚

## 2.ä¿®æ”¹é…ç½®æ–‡ä»¶

å‰é¢è®¸è¯ºä½ ä»¬çš„éªšæã€éªšæ”¹é…ç½®æ–‡ä»¶æ¥å•¦ï¼å®ƒä»¬éƒ½ä½äºconfigæ–‡ä»¶å¤¹ä¸‹ã€‚

### 1ï¼‰ä¿®æ”¹auth.php

```php
'defaults' => [
    'guard' => 'api',  // åŸæ¥æ˜¯balabalaå“ˆå“ˆå“ˆæˆ‘å¿˜äº†å¥½å°´å°¬å“¦æƒ³èµ·æ¥äº†æ˜¯webï¼Œç°åœ¨æ”¹æˆapiï¼Œæ³¨æ„è”ç³»ä¸‹é¢çš„api guardå‘€ï¼
    'passwords' => 'users',
],

'guards' => [
    'web' => [
        'driver' => 'session',
        'provider' => 'users',
    ],
    
    // çœ‹åˆ°æ²¡æœ‰ï¼Œé»˜è®¤guardæ˜¯apiï¼Œä¹Ÿå°±æ˜¯è¯´jwté»˜è®¤å¸®ä½ æŠŠusersè¡¨å½“æˆç”¨æˆ·è¡¨å•¦
    'api' => [
        'driver' => 'jwt',  // åŸæ¥æ˜¯tokenï¼Œæ”¹æˆjwt
        'provider' => 'users',
    ],

    // å› ä¸ºå¤šè¡¨è®¤è¯å•¦ï¼Œæ‰€ä»¥æ–°å¢ä¸€ä¸ªguardï¼Œé…ç½®æ–¹å¼åŒapiï¼Œä¹‹åå°±å¯ä»¥ç”¨é€šè¿‡ä¿®æ”¹auth.defaults.guardæ¥æŒ‡å®šä½¿ç”¨å“ªä¸ªguardäº†ï¼Œå¿«å¤¸æˆ‘
    'admin' => [
        'driver' => 'jwt',
        'provider' => 'admins',
    ],
],

// å› ä¸ºä¿®æ”¹äº†æ¨¡å‹çš„é»˜è®¤è·¯å¾„ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿè¦ä¿®æ”¹ä¸€ä¸‹
'providers' => [
    'users' => [
        'driver' => 'eloquent',
        'model' => App\Models\User::class,
    ],

    'admins' => [
        'driver' => 'eloquent',
        'model' => App\Models\Admin::class,
    ],
],
```

### 2ï¼‰ä¿®æ”¹jwt.php

è¿˜æ˜¯ä¸å¤šè¯´åºŸè¯ï¼Œä¸Šä»£ç ï¼š
å“¦å°´å°¬ï¼Œè¿™ä¸ªä¸ç”¨ä¿®æ”¹å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆï¼Œæˆ‘è®°ä¸²äº†ï¼Œ0.5ç‰ˆæœ¬çš„jwtç”Ÿæˆçš„jwt.phpæ–‡ä»¶é‡Œæœ‰ä¸€é¡¹æ˜¯æŒ‡å®šæ¨¡å‹è·¯å¾„çš„ï¼Œ1.0ç‰ˆæœ¬åˆ æ‰äº†ï¼Œåªè¦auth.phpé‡ŒæŒ‡å®šäº†å°±å¯ä»¥äº†ã€‚å¥½çš„æˆ‘ä»¬è¿›å…¥ä¸‹ä¸€ä¸ªç¯èŠ‚å§æˆ‘æƒ³èµ·æ¥å†å†™ï¼

## 3.å¼€æ’¸ä»£ç 

æ¥æ¥ï¼ŒçœŸæªå®æˆ˜åœ°å¼€å¹²ä¸¤æŠŠï¼

### 1ï¼‰åˆ›å»ºè·¯ç”±

è¿˜è®°å¾—laravelæ€ä¹ˆç”¨å§ï¼Œå…ˆå†™è·¯ç”±ï¼Œæ³¨æ„å•Šï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯å†™apiè®¤è¯ï¼Œæ‰€ä»¥åªè¦å†™æ¥å£å°±å¥½å•¦ï¼Œè·¯ç”±å†™åœ¨api.phpé‡Œï¼
```php
Route::group(['namespace' => 'Home', 'prefix' => 'home'], function () {
    Route::group(['prefix' => 'auth'], function () {
        Route::post('register', 'AuthController@register');
        Route::post('login', 'AuthController@login');
        Route::get('logout', 'AuthController@logout');
        Route::get('me', 'AuthController@me');
    });
});

Route::group(['namespace' => 'Admin', 'prefix' => 'admin', 'middleware' => 'useAdminGuard'], function () {
    Route::group(['prefix' => 'auth'], function () {
        Route::post('register', 'AuthController@register');
        Route::post('login', 'AuthController@login');
        Route::get('logout', 'AuthController@logout');
        Route::get('me', 'AuthController@me');
    });
});
```
æˆ‘ä¸ºäº†çœäº‹å°±ä¸æ‹†å¼€è®²äº†å“ˆï¼Œnamespaceæ˜¯å‘½åç©ºé—´ï¼Œæˆ‘æŠŠå‰åå°æ§åˆ¶å™¨åˆ†åˆ«æ”¾åœ¨Homeå’ŒAdminæ–‡ä»¶å¤¹ä¸‹äº†ï¼Œå»ºè®®ä½ ä»¬å†™ä»£ç å•Šï¼Œå’³å’³ï¼Œå­¦ä¼šæŠŠä»£ç æ–‡ä»¶å½’å¥½ç±»ï¼Œçœ‹ä¸Šå»ä¹Ÿèˆ’æœä¸€äº›æ˜¯å§ï¼Œæ¥è‡ªé•¿è€…çš„ç¢ç¢å¿µã€‚ç»†å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»å‘ç°äº†ï¼Œadminè·¯ç”±ç»„é‡Œå¤šäº†ä¸€ä¸ªuseAdminGuardçš„ä¸­é—´ä»¶ï¼Œè¿™ä¸ªæ˜¯å¹²å˜›ç”¨çš„å‘ï¼Ÿåˆšåˆšæ”¹é…ç½®æ–‡ä»¶çš„æ—¶å€™ä¸æ˜¯è¯´äº†å—ï¼æˆ‘ä»¬è¦æ”¹auth.defaults.guardæ‰èƒ½è‡ªå®šä¹‰jwtå®ˆæŠ¤å“ªä¸ªç”¨æˆ·æ¨¡å‹ï¼Œæ‰€ä»¥è¿™ä¸ªä¸­é—´ä»¶å°±æ˜¯ç”¨æ¥åŠ¨æ€ä¿®æ”¹é…ç½®çš„å‘€~

### 2ï¼‰å¤šè¡¨è®¤è¯

åˆ›å»ºä¸­é—´ä»¶ä¼šå§ï¼Œç®—äº†ä½ ä»¬ä¸è®©æˆ‘çœå¿ƒï¼Œè¯·é”®ç›˜æ•²å‡»æ¢¦æƒ³å¦‚ä¸‹ï¼š
```
php artisan make:middleware useAdminGuard
```
åˆ«å¿˜äº†åœ¨Kernelé‡Œæ³¨å†Œï¼Œå†é—®è‡ªæ€ã€‚
ä¸­é—´ä»¶çš„handleé‡ŒåŠ è¿™ä¹ˆä¸€å¥ï¼š
```php
config(['auth.defaults.guard' => 'admin']);
```
å¥½å•¦ï¼Œå¤§åŠŸå‘Šæˆï¼æˆ‘è¯•è¿‡ç½‘ä¸Šçš„è¾£é¸¡æ•™ç¨‹æ•™çš„æ”¹auth.providers.users.modelä¸º\App\Models\Admin::classï¼Œå¹¶ä¸æ–°å¢ä¸€ä¸ªadminsï¼Œå®Œå…¨æ²¡æœ‰åµç”¨ï¼Œæˆ‘å¡è¿™å¡äº†å¥½ä¹…ï¼Œè°·æ­Œä¹Ÿä¸é è°±ï¼Œæ‰€ä»¥åˆ«ç›¸ä¿¡è°·æ­Œï¼Œè‡³äºç™¾åº¦ï¼Œå‘µï¼

### 3ï¼‰jwtåº•å±‚è®²è§£

é¦–å…ˆæˆ‘ä»¬æ¥ç¼•ä¸€ç¼•jwtåŸç†ï¼Œå…¶å®æ·±å…¥è®²æˆ‘ä¹Ÿä¸ä¼šï¼Œä½†æ˜¯å®ƒå‘¢ï¼Œæ˜¯ç”¨tokenæ¥å®ç°ç”¨æˆ·è®¤è¯çš„ï¼Œè¿™ä¸ªtokenå¾ˆå…³é”®ï¼Œå¼€ç¯‡è®²è¿‡äº†ï¼Œå®ƒç›¸å½“äºä»¤ç‰Œä¸€æ ·ï¼Œå…¶å®å°±æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆç”¨å®ƒå‘¢ï¼Ÿ

å…ˆè´´ä¸€æ³¢laravel jwtçš„ [å®˜æ–¹æ–‡æ¡£](https://jwt-auth.readthedocs.io/en/develop/) ä¾›å¤§å®¶å‚è€ƒï¼Œå¤§å®¶å¯ä»¥ä¸€è¾¹çœ‹å®˜æ–¹æ–‡æ¡£ä¸€è¾¹çœ‹æˆ‘çš„æ•™ç¨‹ã€‚

é¦–å…ˆï¼Œå¤§å®¶å¯ä»¥å‘ç°å®ƒç”¨äº†ä¸€ä¸ªå«åšauth:apiçš„ä¸­é—´ä»¶ï¼Œä½†æ˜¯ä½ æ€ä¹ˆä¹Ÿæ‰¾ä¸åˆ°å¯¹å§ï¼Œè®©æˆ‘å¨“å¨“é“æ¥ã€‚å…¶å®åœ¨1.0ç‰ˆæœ¬ä¹‹å‰ä¾‹å¦‚0.5ç‰ˆæœ¬çš„ä¸­é—´ä»¶å«åšGetUserFromTokenï¼Œæ„æ€å°±æ˜¯ä»tokené‡Œè§£æå‡ºuseræ¥ï¼Œç”¨å®ƒä¹‹å‰è¦ç°åœ¨kernelé‡Œæ³¨å†Œä¸€ä¸‹ï¼š
```php
'jwt.auth' => \Tymon\JWTAuth\Middleware\GetUserFromToken::class,
```
ç„¶åå¤§å®¶å°±å¯ä»¥æŒ‰ä½Ctrlç‚¹è¿›å»çœ‹åˆ°è¿™ä¸ªGetUserFromTokené‡Œé¢éƒ½å†™äº†å•¥ï¼Œä¹‹åå°±å¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰ä¸­é—´ä»¶äº†ã€‚å…¶å®ç°åœ¨1.0ç‰ˆæœ¬çš„jwtä¸­é—´ä»¶å«åšBaseMiddlewareï¼Œå®ƒåŒæ ·å¯ä»¥åœ¨Tymon\JWTAuth\Http\Middlewareä¸‹é¢æ‰¾åˆ°ï¼Œauth:apiæ˜¯å®ƒçš„åˆ«åï¼Œè¿˜è®°å¾—æˆ‘ä»¬åˆšåˆšé…ç½®æ–‡ä»¶é‡Œå†™çš„guardå—ï¼Ÿæˆ‘ä»¬æŠŠé»˜è®¤guardè®¾ç½®æˆäº†apiï¼Œè€Œapiçš„driveræ˜¯jwtï¼Œæ‰€ä»¥å¯ä»¥ç”¨auth:apiæ¥è°ƒç”¨å®ƒã€‚å®˜æ–¹æ–‡æ¡£é‡Œæ²¡æœ‰ä¿®æ”¹auth.defaults.guardçš„å€¼ä¸ºapiï¼Œæ‰€ä»¥åé¢åŠ äº†:apiï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥å®Œå…¨ä¸ç”¨åŠ :apiä¹Ÿèƒ½ç”¨å®ƒè‡ªå¸¦çš„ä¸­é—´ä»¶ï¼Œæ‡‚äº†å§ã€‚

é‚£ç°åœ¨å‘¢ï¼Œæˆ‘å¸Œæœ›å¤§å®¶å·²ç»æ‰“å¼€äº†BaseMiddlewareé˜…è§ˆå®ƒçš„æºä»£ç ï¼Œæ¯•ç«Ÿä¸èƒ½æ€»æ˜¯ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œä½ å¾—å­¦ä¼šçœ‹æºä»£ç ï¼Œæ‰èƒ½æˆé•¿ä¸ºä¸€ä¸ªå·¨äººï¼ˆè£…ä¸ªBï¼Œå…¶å®æˆ‘ä¹Ÿæ˜¯å°ç™½å“ˆå“ˆå“ˆï¼‰

BaseMiddlewareæœ‰ä¸¤ä¸ªå…³é”®çš„methodï¼šcheckForToken()å’Œauthenticate()ï¼Œè¿™ä¾¿æ˜¯jwtè§£ætokençš„è¿‡ç¨‹ï¼Œä»£ç æˆ‘åœ¨è¿™é‡Œä¹Ÿè´´ä¸€ä¸‹ï¼š
```php
public function checkForToken(Request $request)
{
    if (! $this->auth->parser()->setRequest($request)->hasToken()) {
        throw new UnauthorizedHttpException('jwt-auth', 'Token not provided');
    }
}

public function authenticate(Request $request)
{
    this->checkForToken($request);

    try {
        if (! $this->auth->parseToken()->authenticate()) {
            throw new UnauthorizedHttpException('jwt-auth', 'User not found');
        }
    } catch (JWTException $e) {
        throw new UnauthorizedHttpException('jwt-auth', $e->getMessage(), $e, $e->getCode());
    }
}
```
æ•²é»‘æ¿äº†å•Šï¼å¤§å®¶æ³¨æ„ï¼Œå®ƒé¦–å…ˆåˆ¤æ–­è¿™ä¸ªè¯·æ±‚çš„headeré‡Œæœ‰æ²¡æœ‰tokenï¼Œæ²¡æœ‰åˆ™æŠ›å‡º'Token not provided'çš„å¼‚å¸¸ï¼›æ¥ç€ç”¨$this->auth->parseToken()->authenticate()è¿™ä¸ªæ–¹æ³•çœ‹çœ‹èƒ½ä¸èƒ½è§£ææˆåŠŸtokenï¼Œå¦‚æœå¤±è´¥åˆ™æŠ›å‡º'User not found'çš„å¼‚å¸¸ï¼›å¦‚æœè§£æè¿‡ç¨‹ä¸­æŠ¥é”™äº†ï¼Œåˆ™æŠ›å‡ºJWTExceptionå¼‚å¸¸ã€‚çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¤§è‡´å¯¹jwtçš„ä¸­é—´ä»¶æœ‰äº†åŸºæœ¬çš„äº†è§£ï¼Œå·²ç»å¤Ÿç”¨å•¦ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å»è‡ªå®šä¹‰ä¸€ä¸‹æˆ‘ä»¬çš„ä¸­é—´ä»¶ã€‚

### 4ï¼‰è‡ªå®šä¹‰ä¸­é—´ä»¶

è€æ ·å­ï¼Œè´´ä»£ç ï¼Œæˆ‘å£å¹²èˆŒç‡¥æ‡’å¾—è®²äº†ï¼Œå¸Œæœ›æœ‰äººèƒ½è¯·æˆ‘å–å¿«ä¹è‚¥å®…æ°´orå¥¶èŒ¶ï¼

å…ˆåˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„ä¸­é—´ä»¶ï¼š
```
php artisan make:middleware VerifyToken
```
æ¥ä¸‹æ¥æœ‰ä¸¤ç§å†™æ³•ï¼Œå…ˆè®²ç¬¬ä¸€ç§ï¼Œè¿™ç§ä¹Ÿæ˜¯æˆ‘å†™åšå®¢çš„æ—¶å€™éšä¾¿è¯•å‡ºæ¥çš„ï¼Œemmå…¶å®æˆ‘é¡¹ç›®æ—©å°±å†™ä¸€åŠäº†ï¼Œä¸€ç›´æƒ³åšæ•™ç¨‹ä½†æ‡’å¾—åšï¼Œæ‰€ä»¥éƒ½æ˜¯å¤åˆ¶ç²˜è´´ç»™ä½ ä»¬å†™çš„mdã€‚

#### â… .ç»§æ‰¿BaseMiddleware

å“ˆå“ˆå“ˆã€‚å…¶å®å¤§å®¶å¯èƒ½æƒ³åˆ°äº†ï¼Œå°±æ˜¯ç›´æ¥ç»§æ‰¿BaseMiddlewareï¼Œç„¶åå°±èƒ½æŠŠå®ƒçš„æˆå‘˜å˜é‡authï¼ˆå®ƒæ˜¯JWTAuthç±»å‹ï¼‰ä¹Ÿä¸€å—ç»§æ‰¿è¿‡æ¥ï¼Œç„¶åä»£ç ä½ ä»¬å°±çŸ¥é“å’‹å†™å•¦~
```php
try {
     if (! $this->auth->parser()->setRequest($request)->hasToken() || ! $this->auth->parseToken()->authenticate()) {
          throw new JWTException();
     }
} catch (JWTException $e) {
     return response()->json([
          'code' => 2,
          'message' => 'èº«ä»½éªŒè¯æ— æ•ˆï¼Œè¯·ç™»å½•',
     ], 401);
}
```
çœ‹åˆ°æ²¡æœ‰ï¼Œæˆ‘ä»¬ç­‰äºæ˜¯æ ¹æ®BaseMiddlewareè‡ªå®šä¹‰äº†æˆ‘ä»¬çš„ä¸­é—´ä»¶ï¼Œå®ç°äº†è‡ªå®šä¹‰çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæˆ‘è¿™é‡Œçœç•¥äº†å¦å¤–ä¸¤ç±»å¼‚å¸¸ï¼Œå› ä¸ºä½ æƒ³å•Šä½ çš„messageæ˜¯å‰ç«¯æ‹¿æ¥åé¦ˆç»™ç”¨æˆ·çš„ï¼Œç”¨æˆ·çŸ¥é“Token not providedè¿™ä¹ˆé«˜çº§çš„ä¸œè¥¿ï¼Ÿ

ä¸ï¼è¿™æ˜¯åªæœ‰ç¨‹åºå‘˜ï¼Œåªæœ‰phpç¨‹åºå‘˜ï¼Œæœ€é«˜çº§çš„php laravel programmeræ‰ä¼šçŸ¥é“çš„é«˜çº§è¯æ±‡ï¼Œç”¨æˆ·æ€ä¹ˆå¯èƒ½æ‡‚å˜›ä½ è¯´å¯¹ä¸å¯¹ï¼Ÿæ®æˆ‘æ‰€çŸ¥å¾®åŒ—æ´‹ç”¨çš„ä¹Ÿæ˜¯jwtï¼Œæ¯æ¬¡ç™»å½•å¤±è´¥å®ƒéƒ½ç»™æˆ‘å¼¹invalid tokenè¿™ç§é¬¼ä¸œè¥¿ï¼Œä¸€ç‚¹éƒ½ä¸äººæ€§åŒ–ï¼Œæˆ‘ä»¬ç¨‹åºå‘˜ï¼Œè¦äººæ€§åŒ–ï¼æ‰€ä»¥æˆ‘å°±ç»Ÿä¸€æˆäº†ä¸­æ–‡ä¿¡æ¯çš„å¼‚å¸¸ï¼Œä½ ä»¬æƒ³å’‹åŠéƒ½éšæ„~

#### â…¡.ä½¿ç”¨auth()

è¿™ä¸ªauth()æ˜¯laravelè‡ªå¸¦çš„auth()æ¨¡å—ï¼Œåªæ˜¯driverè¢«æˆ‘ä»¬æ”¹æˆäº†jwtï¼Œä»£ç å¦‚ä¸‹ï¼š
```php
if (!auth()->setRequest($request)->getToken() || !auth()->user()) {
     return response()->json([
          'code' => 2,
          'message' => 'èº«ä»½éªŒè¯æ— æ•ˆï¼Œè¯·ç™»å½•',
     ], 401);
}
```
emmè¿™ä¸ªæˆ‘å°±ä¸è®²äº†ï¼Œå¤§åŒå°å¼‚ï¼Œåé¢æˆ‘ä¹Ÿä¼šç»™å¤§å®¶ä¸“é—¨ä»‹ç»auth()çš„å¸¸ç”¨æ–¹æ³•ã€‚

### 5ï¼‰jwtå¸¸ç”¨æ–¹æ³•

#### â… .auth()->attempt()

è¿™ä¸ªæ–¹æ³•å¯ä»¥é€šè¿‡è¯ä¹¦æ¥è®¤è¯ç”¨æˆ·ï¼Œä¾‹å¦‚è´¦å¯†oræ‰‹æœºå·+å¯†oré‚®ç®±+å¯†

#### â…¡.auth()->user()

è¿™ä¸ªæ–¹æ³•å¯ä»¥ä»tokenä¸­è§£æå‡ºç”¨æˆ·

#### â…¢.auth()->logout()

å­—é¢æ„æ€ï¼Œç™»å‡ºã€‚

### 5ï¼‰ç¼–å†™æ§åˆ¶å™¨ä»£ç 

è¿™éƒ¨åˆ†æˆ‘ä¸è®²äº†ï¼Œè‡ªè¡Œçœ‹ä»£ç å°±æ‡‚äº†ï¼Œæ³¨æ„å­¦ä¹ ä¸€ä¸‹æˆ‘çš„ä»£ç è§„èŒƒã€‚

#### â… .å‰å°æ§åˆ¶å™¨

```php
<?php

namespace App\Http\Controllers\Home;

use App\Models\User;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Validator;

class AuthController extends Controller
{
    public function __construct()
    {
        $this->middleware('verifyToken', ['except' => ['register', 'login']]);
    }

    public function register(Request $request) {
        $validator = Validator::make($request->all(), [
            'name' => 'required',
            'phone' => 'required|unique:users|numeric',
            'password' => 'required',
        ], [
            'name.required' => 'åå­—ä¸èƒ½ä¸ºç©º',
            'phone.required' => 'æ‰‹æœºå·ä¸èƒ½ä¸ºç©º',
            'phone.unique' => 'è¯¥æ‰‹æœºå·å·²è¢«æ³¨å†Œ',
            'phone.numeric' => 'æ‰‹æœºå·å¿…é¡»ä¸ºæ•°å­—',
            'password.required' => 'å¯†ç ä¸èƒ½ä¸ºç©º',
        ]);
        if ($validator->fails()) {
            return response()->json([
                'code' => 1,
                'message' => $validator->errors()->first()
            ], 400);
        }
        $user = User::add([
            'name' => $request->input('name'),
            'phone' => $request->input('phone'),
            'password' => bcrypt($request->input('password')),
        ]);
        $token = auth()->login($user);
        return response()->json([
            'code' => 0,
            'message' => 'æ³¨å†ŒæˆåŠŸ',
            'token' => $token
        ]);
    }

    public function login(Request $request) {
        $validator = Validator::make($request->all(), [
            'phone' => 'required|numeric',
            'password' => 'required',
        ], [
            'phone.required' => 'æ‰‹æœºå·ä¸èƒ½ä¸ºç©º',
            'phone.numeric' => 'æ‰‹æœºå·å¿…é¡»ä¸ºæ•°å­—',
            'password.required' => 'å¯†ç ä¸èƒ½ä¸ºç©º',
        ]);
        if ($validator->fails()) {
            return response()->json([
                'code' => 1,
                'message' => $validator->errors()->first()
            ], 400);
        }
        $credentials = $request->only('phone', 'password');
        if (!$token = auth()->attempt($credentials)) {
            return response([
                'code' => 1,
                'message' => 'æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯'
            ], 400);
        }
        return response()->json([
            'code' => 0,
            'message' => 'ç™»å½•æˆåŠŸ',
            'token' => $token
        ]);
    }

    public function logout() {
        auth()->logout();
        return response()->json([
            'code' => 0,
            'message' => 'ç™»å‡ºæˆåŠŸ'
        ]);
    }

    public function me() {
        $user = auth()->user();
        return response()->json([
            'code' => 0,
            'user' => $user
        ]);
    }
}
```

#### â…¡.åå°æ§åˆ¶å™¨
```php
<?php

namespace App\Http\Controllers\Admin;

use App\Models\Admin;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Validator;

class AuthController extends Controller
{
    public function __construct()
    {
        $this->middleware('verifyToken', ['except' => ['register', 'login']]);
    }

    public function register(Request $request) {
        $validator = Validator::make($request->all(), [
            'name' => 'required',
            'password' => 'required',
        ], [
            'name.required' => 'åå­—ä¸èƒ½ä¸ºç©º',
            'password.required' => 'å¯†ç ä¸èƒ½ä¸ºç©º',
        ]);
        if ($validator->fails()) {
            return response()->json([
                'code' => 1,
                'message' => $validator->errors()->first()
            ], 400);
        }
        $admin = Admin::add([
            'name' => $request->input('name'),
            'password' => bcrypt($request->input('password')),
        ]);
        $token = auth()->login($admin);
        return response()->json([
            'code' => 0,
            'message' => 'æ³¨å†ŒæˆåŠŸ',
            'token' => $token
        ]);
    }

    public function login(Request $request) {
        $validator = Validator::make($request->all(), [
            'name' => 'required',
            'password' => 'required',
        ], [
            'name.required' => 'åå­—ä¸èƒ½ä¸ºç©º',
            'password.required' => 'å¯†ç ä¸èƒ½ä¸ºç©º',
        ]);
        if ($validator->fails()) {
            return response()->json([
                'code' => 1,
                'message' => $validator->errors()->first()
            ], 400);
        }
        $credentials = $request->only('name', 'password');
        if (!$token = auth()->attempt($credentials)) {
            return response([
                'code' => 1,
                'message' => 'åå­—æˆ–å¯†ç é”™è¯¯'
            ], 400);
        }
        return response()->json([
            'code' => 0,
            'message' => 'ç™»å½•æˆåŠŸ',
            'token' => $token
        ]);
    }

    public function logout() {
        auth()->logout();
        return response()->json([
            'code' => 0,
            'message' => 'ç™»å‡ºæˆåŠŸ'
        ]);
    }

    public function me() {
        $admin = auth()->user();
        return response()->json([
            'code' => 0,
            'admin' => $admin
        ]);
    }
}
```

# äº”ã€æ€»ç»“

å‘œå‘œå‘œï¼Œå†™åšå®¢çœŸçš„å¥½ç´¯å•Šï¼Œå¿ƒåŠ›äº¤ç˜ï¼Œä»å…¥é—¨åˆ°æ”¾å¼ƒï¼Œæˆ‘æ³¨å®šæ˜¯åªèƒ½ä½äº§äº†ï¼Œå¸Œæœ›å¤§å®¶èƒ½å…³æ³¨ä¸€ä¸‹ [ğŸ‘‰æˆ‘çš„GitHub](https://github.com/qyhxxx)ï¼Œé‡Œé¢æœ‰ä¸ª [laravel-jwt](https://github.com/qyhxxx/laravel-jwt) çš„é¡¹ç›®ï¼Œæ¬¢è¿å¤§å®¶clone or forkï¼

ç»™ä½ ä»¬ç¬”èŠ¯ï¼Œä¸€å®šè¦å…³æ³¨ [ğŸ‘‰æˆ‘çš„GitHub](https://github.com/qyhxxx) å“¦ï¼çˆ±ä½ ä»¬muaï¼